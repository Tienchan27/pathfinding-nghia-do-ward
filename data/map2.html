<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m ƒë∆∞·ªùng ng·∫Øn nh·∫•t</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöó</text></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        #map{
            height: 99vh;
        }
        
        .map-heading {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background-color: rgba(47, 33, 243, 0.9);
            color: white;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .reset-button {
            position: absolute;
            top: 90px;
            left: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background-color: #fff;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .reset-button:hover {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
    <div class="map-heading">T√¨m ƒë∆∞·ªùng ng·∫Øn nh·∫•t</div>
    <button id="resetButton" class="reset-button">Reset Map</button>
    <div id="map"></div>
    <script>
        const server = "http://localhost:5000";
        const api = "/calculate?pntdata=";
        const map = L.map("map").setView([21.04501, 105.79435], 16)
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        let count = 0;
        let firstPoint = {};
        let secondPoint = {};
        let polyline;
        let marker1;
        let marker2;
        listOfBorders = [
        [[21.052119, 105.8044655], [21.0519123, 105.8019208], [21.0518971, 105.8007069], [21.0518683, 105.7948851], 
        [21.0518770, 105.7929903], [21.0519239, 105.7899180], [21.0529624, 105.789934], [21.0543078, 105.789894], 
        [21.0567384, 105.7899398], [21.0567801, 105.7894749], [21.0568018, 105.7889242], [21.0567567, 105.7881302], 
        [21.0566166, 105.7869071], [21.0564521, 105.7863682], [21.0563544, 105.7861994], [21.0563259, 105.7860184], 
        [21.0565464, 105.7844945], [21.0563309, 105.7838983], [21.0562605, 105.7827214], [21.0562174, 105.7823556], 
        [21.055682, 105.7822137], [21.0556820, 105.7822137], [21.0547861, 105.7820122], [21.0538794, 105.7818821], 
        [21.0527298, 105.7817561], [21.0517471, 105.7816911], [21.0489455, 105.7814669], [21.044065, 105.781148], 
        [21.0418452, 105.7810068], [21.0416331, 105.7861868], [21.0416365, 105.7895166], [21.0416374, 105.7904034], 
        [21.0414298, 105.7904551], [21.0412973, 105.7904806], [21.0407558, 105.7905008], [21.0404942, 105.7905006], 
        [21.0403297, 105.7905004], [21.0377419, 105.7937663], [21.0377419, 105.7937663], [21.0377192, 105.7947095], 
        [21.0393052, 105.7947014], [21.0392807, 105.7956182], [21.0388844, 105.7960137], [21.0390337, 105.7976838], 
        [21.0375392, 105.7977528], [21.0364924, 105.7977644], [21.0355335, 105.7976529], [21.0339550, 105.7973765], 
        [21.0332112, 105.7981326], [21.0317769, 105.7995718], [21.0308130, 105.8006044], [21.0302334, 105.8013534], 
        [21.0314831, 105.8024483], [21.0323972, 105.8032814], [21.0327070, 105.8035437], [21.0328399, 105.8036452], 
        [21.0329830, 105.8037413], [21.0340522, 105.8043976], [21.0342912, 105.8045434], [21.0345160, 105.8046953], 
        [21.0355913, 105.8055566], [21.0363421, 105.8060435], [21.0365929, 105.8061742], [21.0368524, 105.8062751], 
        [21.0370683, 105.806324], [21.0376871, 105.8063836], [21.0381128, 105.8064252], [21.0387044, 105.8064760], 
        [21.0388958, 105.8064592], [21.0396488, 105.8063176], [21.0398394, 105.8062645], [21.0400902, 105.8062057], 
        [21.040179, 105.8066358], [21.0401790, 105.8066358], [21.0402543, 105.8069306], [21.0407892, 105.8067149], 
        [21.0414391, 105.8064931], [21.0421465, 105.8063760], [21.0426756, 105.8063452], [21.0434635, 105.8063575], 
        [21.0441479, 105.8063267], [21.0454419, 105.8060925], [21.0479544, 105.8051485], [21.0495022, 105.8047424], 
        [21.0503104, 105.8045961], [21.0514979, 105.8044782], [21.0519150, 105.8044697], [21.0521190, 105.8044655]]

        ]
        for (let i = 0; i < listOfBorders.length; i++){
            let border = L.polyline(listOfBorders[i], {weight: 4, opacity:1, color:'red'})
            border.addTo(map)
        }
        function onMapClick(e) {
            if (count == 0){
                firstPoint.lat = e.latlng.lat
                firstPoint.lng = e.latlng.lng
                count += 1;
                marker1 = L.marker([firstPoint.lat, firstPoint.lng])
                marker1.addTo(map);
            }
            else if (count == 1){
                secondPoint.lat = e.latlng.lat
                secondPoint.lng = e.latlng.lng
                marker2 = L.marker([secondPoint.lat, secondPoint.lng])
                marker2.addTo(map);
                count += 1;
                fetch(server + api + firstPoint.lat + ',' + firstPoint.lng + ',' + secondPoint.lat + ',' + secondPoint.lng, {
                    "mode": "cors"
                })
                .then((res) => {
                    console.log("Response status:", res.status);
                    if (res.status == 200){
                        return(res.json())
                    }
                    else{
                        console.log("Failed response:", res);
                        alert("Fail to find the shortest path")
                    }
                })
                .then((array) => {
                    console.log("Received path data:", array);
                    polyline = L.polyline(array)
                    polyline.addTo(map);
                    dashPolyline = L.polyline([array[0], [secondPoint.lat, secondPoint.lng]], {"dashArray": "10", "dashOffset": 3, "color": "gray"}).addTo(map)
                    dashPolyline2 = L.polyline([array[array.length - 1], [firstPoint.lat, firstPoint.lng]], {"dashArray": "4", "dashOffset": 3, "color": "gray"}).addTo(map)
                })
                .catch((e) => {
                    console.error("Error:", e);
                    alert("Can't Find A Path")
                })
            }
            else if (count == 2){
                count = 0;
                map.removeLayer(marker1)
                map.removeLayer(marker2)
                map.removeLayer(polyline)
                map.removeLayer(dashPolyline)
                map.removeLayer(dashPolyline2)
            }
        }

        map.on('click', onMapClick);

        L.Control.geocoder({
            defaultMarkGeocode: false,
            geocoder: L.Control.Geocoder.nominatim({
                geocodingQueryParams: {
                    viewbox: '105.73,20.96,105.96,21.09', 
                    bounded: 1,
                    countrycodes: 'vn',
                    addressdetails: 1, 
                    limit: 10, 
                    'accept-language': 'vi'
                }
            }),
            placeholder: 'Nh·∫≠p ƒë·ªãa ch·ªâ c·∫ßn t√¨m...',
            suggestMinLength: 3, 
            position: 'topright',
            showResultIcons: true
        })
        .on('markgeocode', function(e) {
            const lat = e.geocode.center.lat;
            const lng = e.geocode.center.lng;

            if (count == 0) {
                firstPoint.lat = lat;
                firstPoint.lng = lng;
                count += 1;
                marker1 = L.marker([lat, lng]).addTo(map)
                    .bindPopup(e.geocode.name)
                    .openPopup();
            } else if (count == 1) {
                secondPoint.lat = lat;
                secondPoint.lng = lng;
                count += 1;
                marker2 = L.marker([lat, lng]).addTo(map)
                    .bindPopup(e.geocode.name)
                    .openPopup();

                fetch(server + api + firstPoint.lat + ',' + firstPoint.lng + ',' + secondPoint.lat + ',' + secondPoint.lng, {
                    "mode": "cors"
                })
                .then((res) => {
                    if (res.status == 200) {
                        return res.json();
                    } else {
                        alert("Fail to find the shortest path");
                    }
                })
                .then((array) => {
                    polyline = L.polyline(array).addTo(map);
                    dashPolyline = L.polyline([array[0], [secondPoint.lat, secondPoint.lng]], {"dashArray": "10", "dashOffset": 3, "color": "gray"}).addTo(map);
                    dashPolyline2 = L.polyline([array[array.length - 1], [firstPoint.lat, firstPoint.lng]], {"dashArray": "4", "dashOffset": 3, "color": "gray"}).addTo(map);
                })
                .catch((e) => {
                    alert("Can't Find A Path");
                });
            }
        })
        .addTo(map);

        function update() {
            var new_data = "".concat(destination.lat, " ", destination.lng);
            $.ajax({
                url: "/update",
                type: "POST",
                data: { data: new_data },
                success: function () {
                    console.log("success");
                }
            });
        }

        function resetMap() {
            // Clear existing markers and paths
            if (marker1) {
                map.removeLayer(marker1);
                marker1 = null;
            }
            if (marker2) {
                map.removeLayer(marker2);
                marker2 = null;
            }
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            
            // Clear blocked edges file
            fetch('/clear_blocked_edges', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                console.log('Blocked edges cleared');
            })
            .catch(error => {
                console.error('Error clearing blocked edges:', error);
            });
        }
        
        // Add click event listener to reset button
        document.getElementById('resetButton').addEventListener('click', resetMap);
    </script>
</body>
</html>
